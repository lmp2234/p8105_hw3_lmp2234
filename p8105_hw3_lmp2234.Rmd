---
title: "p8105_hw3_lmp2234"
author: "Lisa Pardee"
date: "2024-10-16"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Loading the necessary libraries
```{r}
library(p8105.datasets)
library(tidyverse)
library(janitor)
library(dplyr)
library(lubridate)
library(ggplot2)
library(patchwork)
library(tidyr)

```


```{r}

data("ny_noaa")

summary(ny_noaa)
dim(ny_noaa)

sum(is.na(ny_noaa))
colSums(is.na(ny_noaa))

total_obs<-nrow(ny_noaa)

missing_sum <-data.frame(
  variable = colnames(ny_noaa), 
  missing_values = colSums(is.na(ny_noaa)), 
  missing_percentage = (colSums(is.na(ny_noaa)) / total_obs) * 100 ) 

missing_sum<-missing_sum[missing_sum$missing_values >0, ]
missing_sum


```
The data set provides weather data and contains `r nrow(ny_noaa)` observations and `r ncol(ny_noaa)` variables.The variables named are weather station id (id), date of observation (date), precipitation (prcp) snowfall (snow), snow depth (snwd), maximum temperature (tmax), and minimum temperature (tmin). There is a total of 3387623 missing data values. The variables that have missing data are prcp, snow, snwd, tmax, and tmin. There is a very large portion of missing data for minimum and maximum data, and much missing data for snow and snwd. Overall, this dataset has a substantial portion of missing data. 

#Data Cleaning 
```{r}

ny_noaa <- ny_noaa %>%
  clean_names() %>%
  mutate(
    prcp = as.numeric(prcp),
    tmax = as.numeric(tmax),
    tmin = as.numeric(tmin),
    snow = as.numeric(snow),
    snwd = as.numeric(snwd),
    year = year(ymd(date)),
    month = month(ymd(date)),
    day = day(date), 
    prcp = prcp / 10, 
    tmax = tmax / 10, 
    tmin = tmin / 10
  )
  
snowfall_common <-ny_noaa %>%
  filter(snow>0) %>%
  count(snow)%>%
  arrange(snow)

top_n<-5

top_snowfall <- head(snowfall_common, n = top_n) 
top_snowfall


```
For snowfall, the most commonly observed values are for the smallest recorded snow fall in mm. These are expected to be the most common, because this amount of snowfall is more likely to occur as compared to more extreme weather events that occur more rarely. 

```{r}


avg_temp <- ny_noaa %>%
  filter(month %in% c(1, 7)) %>%  
  group_by(id, year, month) %>%  
  summarize(avg_tmax = mean(tmax, na.rm = TRUE), .groups = 'drop')  


ggplot(avg_temp, aes(x = as.factor(month), y = avg_tmax, fill = as.factor(month))) +
  geom_boxplot() +
  scale_fill_manual(values = c("blue", "red"), 
                    labels = c("January", "July")) +
  labs(title = "Boxplot of Average Max Temperatures in January and July", 
       x = "Month", 
       y = "Average Max Temperature (°C)", 
       fill = "Month") +
  theme_minimal()
```

The plots for both January and July appear approximately normally distributed. The average max temperatures are higher July (median of 27 degrees Celsius), compared to January (median of 0 degrees Celsius), which is expected. There is less variability in temperatures for July since the size of the box (i.e., interquartile range) is smaller compared to the box for January. There is more variability in extreme temperature values in January since the whiskers are longer. There apepars to be a few outliers in box January and July which indicate the presence of extreme weather events. 

```{r}



density_plot<-ggplot(ny_noaa, aes(x = tmax, y = tmin)) +
  geom_density_2d_filled(alpha = 0.5) +
  labs(title = "Density Plot of Max vs Min Temperature",
       x = "Max Temperature (°C) ",
       y = "Min Temperature (°C)") +
  theme_minimal()

box_plot <- ggplot(ny_noaa, aes(x = tmax, y = tmin)) +
  geom_boxplot() +
  labs(title = "Box Plot of Min Temperature by Binned Max Temperature",
       x = "Max Temperature (°C) ",
       y = "Min Temperature (°C)") +
  theme_minimal()

combined_plot <- density_plot + box_plot

print(combined_plot)

```

```{r}
filtered_snow <- ny_noaa %>%
  filter(snow > 0 & snow < 100)


snowfall_plot_violin <- ggplot(filtered_snow, aes(x = factor(year), y = snow, fill = factor(year))) +
  geom_violin(alpha = 0.7) +
  labs(title = "Distribution of Snowfall Values (0 < snow < 100) by Year",
       x = "Year",
       y = "Snowfall (mm)",
       fill = "Year") +
  theme_minimal() +
  theme(legend.position = "none")


print(snowfall_plot_violin)
```
##Question 2

```{r}
covar <- read.csv("./data/nhanes_covar.csv", na.strings = c("NA", "", "."), skip = 4) %>%
  janitor::clean_names() %>%
  filter(age >= 21, !is.na(seqn)) %>%
  mutate(
    sex = factor(sex, levels = c(1, 2), labels = c("Male", "Female")),
    education = factor(education, levels = c(1, 2, 3), labels = c("Less than high school", "High school equivalent", "More than high school"))
  )

accel <- read.csv("./data/nhanes_accel.csv", na.strings = c("NA", "", ".")) %>%
  janitor::clean_names()

fas_df = 
  full_join(covar, accel, by = "seqn")%>%
  drop_na()

fas_df
```


```{r}
education_summary <- fas_df %>%
  group_by(education, sex) %>%
  summarise(count = n(), .groups = "drop") %>%
  pivot_wider(names_from = sex, values_from = count, values_fill = list(count = 0))

print(education_summary)
```
#This table shows education levels for males and females. For the category of more than high school and less than high school, the number of males and females is similar. However, for high school equivalent, there are more men in this category compared to females. 

```{r}
age_distribution_histogram <- ggplot(fas_df, aes(x = age, fill = sex)) +
  geom_histogram(position = "identity", alpha = 0.5, bins = 30) +
  facet_wrap(~ education, labeller = label_both) +
  labs(title = "Age Distributions by Sex and Education Category",
       x = "Age",
       y = "Count") +
  theme_minimal() +
  theme(legend.title = element_blank())

print(age_distribution_histogram)
```

```{r}
total_activity <- fas_df %>%
  mutate(total_activity_minutes = rowSums(select(., starts_with("min")), na.rm = TRUE)) %>%
  select(seqn, total_activity_minutes)

fas_df <- fas_df %>%
  left_join(total_activity, by = "seqn")

print(head(fas_df))

activity_plot <- ggplot(fas_df, aes(x = age, y = total_activity_minutes, color = sex)) +
  geom_point(alpha = 0.6) +  
  geom_smooth(method = "loess", se = FALSE) + 
  labs(title = "Total Activity Minutes by Age and Education Level",
       x = "Age (years)",
       y = "Total Activity Minutes") +
  facet_wrap(~ education) +  
  theme_minimal() +
  theme(legend.title = element_blank())

# Display the plot
print(activity_plot)
```

```{r}
activity_long <- fas_df %>%
  pivot_longer(cols = starts_with("min"), 
               names_to = "time_point", 
               values_to = "activity_minutes") %>%
  mutate(time_point = as.numeric(sub("min", "", time_point)))

activity_plot <- ggplot(activity_long, aes(x = time_point, y = activity_minutes, color = sex, group = seqn)) +
  geom_line(alpha = 0.4) +  
  labs(title = "24-Hour Activity Time Courses by Education Level",
       x = "Time Point (Min)",
       y = "Activity Minutes") +
  facet_wrap(~ education, ncol = 1) +  
  theme_minimal() +
  theme(legend.title = element_blank())

print(activity_plot)
```
#Question 3 

```{r}

Jan_2020 <- read.csv("./data/Jan 2020 Citi.csv", na.strings = c("NA", "", ".")) %>%
  janitor::clean_names() %>%
  rename(duration_minutes = duration) %>%
  rename(membership_type = member_casual) %>%
  rename(ride_type = rideable_type) %>%
  mutate(Date = "January 2020")

Jan_2024 <- read.csv("./data/Jan 2024 Citi.csv", na.strings = c("NA", "", ".")) %>%
  janitor::clean_names() %>%
  rename(duration_minutes = duration) %>%
  rename(membership_type = member_casual) %>%
  rename(ride_type = rideable_type) %>%
  mutate(Date = "January 2024")

July_2020 <- read.csv("./data/July 2020 Citi.csv", na.strings = c("NA", "", ".")) %>%
  janitor::clean_names() %>%
  rename(duration_minutes = duration) %>%
  rename(membership_type = member_casual) %>%
  rename(ride_type = rideable_type) %>%
  mutate(Date = "July 2020")

July_2024 <- read.csv("./data/July 2024 Citi.csv", na.strings = c("NA", "", ".")) %>%
  janitor::clean_names() %>%
  rename(duration_minutes = duration) %>%
  rename(membership_type = member_casual) %>%
  rename(ride_type = rideable_type) %>%
  mutate(Date = "July 2024")

combined_data <- bind_rows(Jan_2020, Jan_2024, July_2020, July_2024)
combined_data

```
The combined data set provides information on Citi Bike utilization in New York City for January 2020, January 2024, July 2020, and July 2024, and contains `r nrow(combined_data)` observations and `r ncol(combined_data)` variables.The variable names include ride_id, ride_type, weekdays, duration_minutes, start_station_name, end_station_name, membership_type, and date. Each dataset had the same column names so they were combined using the bind rows option. Some of the original variables (duration, member_casual, and rideable_type" were renamed for clarity purposes. In the dataset, there were no missing (NA values) for any variable except for start_station_name. 

```{r}
combined_table<-combined_data  %>%
  group_by(Date, membership_type)%>%
  summarize(total_rides = n(), .groups = 'drop')%>%
  arrange(Date, membership_type)%>%
  pivot_wider(names_from = membership_type, values_from = total_rides)


  print(combined_table)
```
#These results show that the total number of rides was highest in July 2024 for both casual and member riders. The lowest total number or rides was January 2020 for both type. This also signifies that with time, the total number of rides for casual rider and Citi Bike member utilization has risen. 

```{r}
popular_stations<-combined_data  %>%
  filter(Date=="July 2024")  %>%
  group_by (start_station_name)  %>%
  summarize(num_rides =n()) %>%
  arrange(desc(num_rides)) %>%
  slice_head(n=5)

print(popular_stations)
```
#The 5 most popular starting stations were Pier 61, University Place, W 21 St & 6 Ave, West St & Chambers St, and W 31 St & 7th Ave. Pier 61 at Chelsea Piers had the highest number of rides. 


```{r}

median_duration <- combined_data %>%
  group_by(weekdays, Date) %>%
  summarize(median_duration = median(duration_minutes, na.rm = TRUE), .groups = 'drop') %>%
  separate(Date, into = c("month", "year"), sep = " ", convert = TRUE) %>%
  mutate(year = as.factor(year))

ggplot(median_duration, aes(x=weekdays, y=median_duration, color = year))+ geom_point()+
  geom_line(aes(group = year))+
  facet_wrap(~month)+
  labs (title = "Median Ride Duration by Weekday, Month, and Year", x = "Day of the Week", y = "Median Duration (Minutes)", 
        color = "Year") +
  scale_color_manual(values = c("2020" = "blue", "2024" = "orange")) +  
  theme_minimal() 
```
#This plot shows the effects of the day of the week, month, and year on median ride duration. This plot shows that in January 2020, median ride duration was higher compared to January 2024 with the peak weekdays for 2020 being Saturday and Sunday. For July, the highest median duration was in July 2020 compared to July 2024 with the peak weekdays also being the weekend. 

```{r}
year_2024 <- combined_data %>%
  filter (grepl("2024", Date)) %>%
  separate(Date, into = c("month", "year"), sep = " ", convert = TRUE)

ggplot(year_2024, aes(x = month, y = duration_minutes, fill = membership_type)) +
  geom_boxplot(position = "dodge") +  
  facet_wrap(~ ride_type) +       
  labs(title = "Distribution of Ride Duration, 2024",
       x = "Month",
       y = "Duration (Minutes)",
       fill = "Membership Status") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 
```
#This plot shows the distribution of ride duration for casual and members in 2024 by bike type. Among those with classic bikes, the distributions for casual and members were similar in January and July. However, for the electric bikes category, casual members tended to have longer ride durations compared to members in July 2024. Also, casual members that used electric bikes in July had a higher median duration of rides. 







